{% extends "faculty/faculty-dashboard.html" %}

{% block content %}

<!-- Title Page -->
<div class="page-title mb-4" style="margin:15px;">
    <h2 style="color: #615EFC; font-weight: bold; margin-right: 20px; padding-left: 50px;">Attendance Record</h2>
    <hr style="margin-top: 0; color: black;">
</div>


  <!-- Adviser Information -->
  <label style="padding: 4vh 1vw 0;">Adviser</label>
  <h3 id="adviser-name" style="padding: 0 1vw;"></h3>
  <h4 id="adviser-section" style="color: #615EFC; padding: 0 1vw;"></h4>

<div class="container">
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead class="thead-dark">
                <tr>
                    <th>Student ID</th>
                    <th>Name</th>
                    <th>Attendance</th>
                </tr>
            </thead>
            <tbody id="student-table-body">
                <!-- Data will be inserted here dynamically -->
            </tbody>
        </table>
    </div>
</div>

<!-- jQuery (Make sure it's included) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  function markAttendance(studentLrn, status) {
      let confirmation = confirm(`Are you sure you want to mark Student ${studentLrn} as ${status}?`);
      
      if (confirmation) {
          $.ajax({
              url: "{% url 'mark_attendance' %}",  // Ensure this URL is defined in urls.py
              type: "POST",
              data: {
                  student_lrn: studentLrn,
                  status: status,
                  csrfmiddlewaretoken: "{{ csrf_token }}"
              },
              success: function(response) {
                  console.log(`Attendance marked as ${status} for Student ${studentLrn}`);
                  location.reload();
              },
              error: function(xhr, status, error) {
                  console.error("Error marking attendance:", error);
                  alert("Failed to mark attendance. Please try again.");
              }
          });
      }
  }

  $(document).ready(function() {
      fetchStudents(); // Call function on page load

      function fetchStudents() {
          $.ajax({
              url: "{% url 'fetch_students' %}", 
              type: "GET",
              dataType: "json",
              success: function(response) {
                  console.log(response);

                  let students = response.students;
                  let adviser = response.adviser;

                  // Update Adviser Information
                  if (adviser) {
                      $("h3#adviser-name").text(`${adviser.surname} ${adviser.first_name}`);
                      $("h4#adviser-section").text(`Section: ${adviser.section}`);
                  }

                  let tableBody = $("#student-table-body");
                  tableBody.empty();

                  if (students.length === 0) {
                      tableBody.append("<tr><td colspan='3' class='text-center'>No students need attendance.</td></tr>");
                  } else {
                      students.forEach(student => {
                          let middleName = student.middle_name ? student.middle_name : "";
                          let row = `
                              <tr>
                                  <td>${student.student_lrn}</td>
                                  <td>${student.surname}, ${student.first_name} ${middleName}</td>
                                  <td>
                                      <button class="btn btn-success btn-sm" onclick="markAttendance('${student.student_lrn}', 'Present')">Present</button>
                                      <button class="btn btn-danger btn-sm" onclick="markAttendance('${student.student_lrn}', 'Absent')">Absent</button>
                                  </td>
                              </tr>
                          `;
                          tableBody.append(row);
                      });
                  }
              },
              error: function(xhr, status, error) {
                  console.error("Error fetching students:", error);
              }
          });
      }
  });
</script>



{% endblock content %}
